/*
 * Wazuh storeRemediationsModel
 * Copyright (C) 2015, Wazuh Inc.
 * October 05, 2023.
 *
 * This program is free software; you can redistribute it
 * and/or modify it under the terms of the GNU General Public
 * License (version 2) as published by the FSF - Free Software
 * Foundation.
 */

#include "storeRemediationsModel_test.h"
#include "flatbuffers/flatbuffers.h"
#include "flatbuffers/idl.h"
#include "flatbuffers/util.h"

constexpr auto COMMON_DATABASE_DIR {"queue/vd"}; //<<Used for all databases
const std::string FLATBUFFER_SCHEMA {FLATBUFFER_SCHEMAS_DIR "/cve5.fbs"};
const char* FB_INCLUDE_DIRECTORIES[] = {FLATBUFFER_SCHEMAS_DIR, nullptr};

auto JSON_CVE5_VALID = R"(
    {
        "dataType": "CVE_RECORD",
        "dataVersion": "5.0",
        "cveMetadata": {
            "cveId": "CVE-1337-1234",
            "assignerOrgId": "b3476cb9-2e3d-41a6-98d0-0f47421a65b6",
            "state": "PUBLISHED"
        },
        "containers": {
            "cna": {
                "providerMetadata": {
                    "orgId": "b3476cb9-2e3d-41a6-98d0-0f47421a65b6"
                },
                "problemTypes": [
                    {
                        "descriptions": [
                            {
                                "lang": "en",
                                "description": "CWE-78 OS Command Injection"
                            }
                        ]
                    }
                ],
                "affected": [
                    {
                        "vendor": "Example.org",
                        "product": "Example Enterprise",
                        "versions": [
                            {
                                "version": "1.0.0",
                                "status": "affected",
                                "lessThan": "1.0.6",
                                "versionType": "semver"
                            }
                        ],
                        "defaultStatus": "unaffected"
                    }
                ],
                "descriptions": [
                    {
                        "lang": "en",
                        "value": "OS Command Injection vulnerability parseFilename function of example.php in the Web Management Interface of Example.org Example Enterprise on Windows, MacOS and XT-4500 allows remote unauthenticated attackers to escalate privileges.\n\nThis issue affects:\n  *  1.0 versions before 1.0.6\n  *  2.1 versions from 2.16 until 2.1.9."
                    }
                ],
                "references": [
                    {
                        "url": "https://example.org/ESA-22-11-CVE-1337-1234"
                    }
                ],
                "x_remediations": {
                    "windows": [
                        {
                            "anyOf":["KBT-800","KBT-1000","KBT-3000"],
                            "products": ["Windows 10 - HastaLaVistaBaby", "Windows 11 - RiseOfTheMachines", "Windows 12 - Genisys"],
                            "type": "update"
                        }
                    ]
                }
            }
        }
    }
)";

auto JSON_CVE5_EMPTY_WINDOWS = R"(
    {
        "dataType": "CVE_RECORD",
        "dataVersion": "5.0",
        "cveMetadata": {
            "cveId": "CVE-1337-1234",
            "assignerOrgId": "b3476cb9-2e3d-41a6-98d0-0f47421a65b6",
            "state": "PUBLISHED"
        },
        "containers": {
            "cna": {
                "providerMetadata": {
                    "orgId": "b3476cb9-2e3d-41a6-98d0-0f47421a65b6"
                },
                "problemTypes": [
                    {
                        "descriptions": [
                            {
                                "lang": "en",
                                "description": "CWE-78 OS Command Injection"
                            }
                        ]
                    }
                ],
                "affected": [
                    {
                        "vendor": "Example.org",
                        "product": "Example Enterprise",
                        "versions": [
                            {
                                "version": "1.0.0",
                                "status": "affected",
                                "lessThan": "1.0.6",
                                "versionType": "semver"
                            }
                        ],
                        "defaultStatus": "unaffected"
                    }
                ],
                "descriptions": [
                    {
                        "lang": "en",
                        "value": "OS Command Injection vulnerability parseFilename function of example.php in the Web Management Interface of Example.org Example Enterprise on Windows, MacOS and XT-4500 allows remote unauthenticated attackers to escalate privileges.\n\nThis issue affects:\n  *  1.0 versions before 1.0.6\n  *  2.1 versions from 2.16 until 2.1.9."
                    }
                ],
                "references": [
                    {
                        "url": "https://example.org/ESA-22-11-CVE-1337-1234"
                    }
                ],
                "x_remediations": {
                    "alpine": [
                        {
                            "anyOf":["KBT-800","KBT-1000","KBT-3000"],
                            "products": ["Windows 10 - HastaLaVistaBaby", "Windows 11 - RiseOfTheMachines", "Windows 12 - Genisys"],
                            "type": "update"
                        }
                    ]
                }
            }
        }
    }
)";

auto JSON_CVE5_EMPTY_UPDATES = R"(
    {
        "dataType": "CVE_RECORD",
        "dataVersion": "5.0",
        "cveMetadata": {
            "cveId": "CVE-1337-1234",
            "assignerOrgId": "b3476cb9-2e3d-41a6-98d0-0f47421a65b6",
            "state": "PUBLISHED"
        },
        "containers": {
            "cna": {
                "providerMetadata": {
                    "orgId": "b3476cb9-2e3d-41a6-98d0-0f47421a65b6"
                },
                "problemTypes": [
                    {
                        "descriptions": [
                            {
                                "lang": "en",
                                "description": "CWE-78 OS Command Injection"
                            }
                        ]
                    }
                ],
                "affected": [
                    {
                        "vendor": "Example.org",
                        "product": "Example Enterprise",
                        "versions": [
                            {
                                "version": "1.0.0",
                                "status": "affected",
                                "lessThan": "1.0.6",
                                "versionType": "semver"
                            }
                        ],
                        "defaultStatus": "unaffected"
                    }
                ],
                "descriptions": [
                    {
                        "lang": "en",
                        "value": "OS Command Injection vulnerability parseFilename function of example.php in the Web Management Interface of Example.org Example Enterprise on Windows, MacOS and XT-4500 allows remote unauthenticated attackers to escalate privileges.\n\nThis issue affects:\n  *  1.0 versions before 1.0.6\n  *  2.1 versions from 2.16 until 2.1.9."
                    }
                ],
                "references": [
                    {
                        "url": "https://example.org/ESA-22-11-CVE-1337-1234"
                    }
                ],
                "x_remediations": {
                    "windows": [
                        {
                            "products": ["Windows 10 - HastaLaVistaBaby", "Windows 11 - RiseOfTheMachines", "Windows 12 - Genisys"],
                            "type": "update"
                        }
                    ]
                }
            }
        }
    }
)";

auto JSON_CVE5_NO_REMEDIATIONS = R"(
    {
        "dataType": "CVE_RECORD",
        "dataVersion": "5.0",
        "cveMetadata": {
            "cveId": "CVE-1337-1234",
            "assignerOrgId": "b3476cb9-2e3d-41a6-98d0-0f47421a65b6",
            "state": "PUBLISHED"
        },
        "containers": {
            "cna": {
                "providerMetadata": {
                    "orgId": "b3476cb9-2e3d-41a6-98d0-0f47421a65b6"
                },
                "problemTypes": [
                    {
                        "descriptions": [
                            {
                                "lang": "en",
                                "description": "CWE-78 OS Command Injection"
                            }
                        ]
                    }
                ],
                "affected": [
                    {
                        "vendor": "Example.org",
                        "product": "Example Enterprise",
                        "versions": [
                            {
                                "version": "1.0.0",
                                "status": "affected",
                                "lessThan": "1.0.6",
                                "versionType": "semver"
                            }
                        ],
                        "defaultStatus": "unaffected"
                    }
                ],
                "descriptions": [
                    {
                        "lang": "en",
                        "value": "OS Command Injection vulnerability parseFilename function of example.php in the Web Management Interface of Example.org Example Enterprise on Windows, MacOS and XT-4500 allows remote unauthenticated attackers to escalate privileges.\n\nThis issue affects:\n  *  1.0 versions before 1.0.6\n  *  2.1 versions from 2.16 until 2.1.9."
                    }
                ],
                "references": [
                    {
                        "url": "https://example.org/ESA-22-11-CVE-1337-1234"
                    }
                ],
            }
        }
    }
)";

void StoreRemediationsModelTest::SetUp()
{
    std::filesystem::create_directories(COMMON_DATABASE_DIR);
};

void StoreRemediationsModelTest::TearDown()
{
    std::filesystem::remove_all(COMMON_DATABASE_DIR);
};

TEST_F(StoreRemediationsModelTest, UpdatesWindowsRemediation)
{
    // Define schema variable and parse JSON object.
    std::string schemaStr;

    // Load file with schema.
    bool valid = flatbuffers::LoadFile(FLATBUFFER_SCHEMA.c_str(), false, &schemaStr);
    EXPECT_TRUE(valid);

    // Parse schema.
    flatbuffers::Parser parser;
    valid = parser.Parse(schemaStr.c_str(), FB_INCLUDE_DIRECTORIES) && parser.Parse(JSON_CVE5_VALID);
    EXPECT_TRUE(valid);

    // Create a test Entry object with Windows remediations
    auto jbuf = parser.builder_.GetBufferPointer();
    flatbuffers::Verifier jverifier(jbuf, parser.builder_.GetSize());
    EXPECT_TRUE(cve_v5::VerifyEntryBuffer(jverifier));
    auto entry = cve_v5::GetEntry(jbuf);

    // Create a mock RocksDBWrapper object
    Utils::RocksDBWrapper rocksDBWrapper(REMEDIATIONS_DATABASE_PATH);

    // Call the updateRemediation function with the test data
    EXPECT_NO_THROW(StoreRemediationsModel::updateRemediation(entry, rocksDBWrapper));

    // Assert result.
    std::string cveId {"CVE-1337-1234"};
    FlatbufferDataPair<RemediationInfo> dtoVulnRemediation;

    // Asserts
    EXPECT_NO_THROW(rocksDBWrapper.get(cveId, dtoVulnRemediation.slice));
    dtoVulnRemediation.data = const_cast<NSVulnerabilityScanner::RemediationInfo*>(
        NSVulnerabilityScanner::GetRemediationInfo(dtoVulnRemediation.slice.data()));

    EXPECT_STREQ(dtoVulnRemediation.data->updates()->Get(0)->str().c_str(), "KBT-800");
    EXPECT_STREQ(dtoVulnRemediation.data->updates()->Get(1)->str().c_str(), "KBT-1000");
    EXPECT_STREQ(dtoVulnRemediation.data->updates()->Get(2)->str().c_str(), "KBT-3000");
}

TEST_F(StoreRemediationsModelTest, SkipsEmptyRemediations)
{
    // Define schema variable and parse JSON object.
    std::string schemaStr;

    // Load file with schema.
    bool valid = flatbuffers::LoadFile(FLATBUFFER_SCHEMA.c_str(), false, &schemaStr);
    EXPECT_TRUE(valid);

    // Parse schema.
    flatbuffers::Parser parser;
    valid = parser.Parse(schemaStr.c_str(), FB_INCLUDE_DIRECTORIES) && parser.Parse(JSON_CVE5_EMPTY_WINDOWS);
    EXPECT_TRUE(valid);

    // Create a test Entry object with Windows remediations
    auto jbuf = parser.builder_.GetBufferPointer();
    flatbuffers::Verifier jverifier(jbuf, parser.builder_.GetSize());
    EXPECT_TRUE(cve_v5::VerifyEntryBuffer(jverifier));
    auto entry = cve_v5::GetEntry(jbuf);

    // Create a mock RocksDBWrapper object
    Utils::RocksDBWrapper rocksDBWrapper(REMEDIATIONS_DATABASE_PATH);

    // Assert result.
    ::testing::internal::CaptureStderr();
    EXPECT_NO_THROW(StoreRemediationsModel::updateRemediation(entry, rocksDBWrapper));
    std::string capturedSterr = ::testing::internal::GetCapturedStderr();
    EXPECT_STREQ("Empty remediations.\n", capturedSterr.c_str());
}

TEST_F(StoreRemediationsModelTest, SkipsEmptyUpdates)
{
    // Define schema variable and parse JSON object.
    std::string schemaStr;

    // Load file with schema.
    bool valid = flatbuffers::LoadFile(FLATBUFFER_SCHEMA.c_str(), false, &schemaStr);
    EXPECT_TRUE(valid);

    // Parse schema.
    flatbuffers::Parser parser;
    valid = parser.Parse(schemaStr.c_str(), FB_INCLUDE_DIRECTORIES) && parser.Parse(JSON_CVE5_EMPTY_UPDATES);
    EXPECT_TRUE(valid);

    // Create a test Entry object with Windows remediations
    auto jbuf = parser.builder_.GetBufferPointer();
    flatbuffers::Verifier jverifier(jbuf, parser.builder_.GetSize());
    EXPECT_TRUE(cve_v5::VerifyEntryBuffer(jverifier));
    auto entry = cve_v5::GetEntry(jbuf);

    // Create a mock RocksDBWrapper object
    Utils::RocksDBWrapper rocksDBWrapper(REMEDIATIONS_DATABASE_PATH);

    // Assert result.
    ::testing::internal::CaptureStderr();
    EXPECT_NO_THROW(StoreRemediationsModel::updateRemediation(entry, rocksDBWrapper));
    std::string capturedSterr = ::testing::internal::GetCapturedStderr();
    EXPECT_STREQ("No updates available.\n", capturedSterr.c_str());
}

TEST_F(StoreRemediationsModelTest, x_remediationsNotPresent)
{
    // Define schema variable and parse JSON object.
    std::string schemaStr;

    // Load file with schema.
    bool valid = flatbuffers::LoadFile(FLATBUFFER_SCHEMA.c_str(), false, &schemaStr);
    EXPECT_TRUE(valid);

    // Parse schema.
    flatbuffers::Parser parser;
    valid = parser.Parse(schemaStr.c_str(), FB_INCLUDE_DIRECTORIES) && parser.Parse(JSON_CVE5_NO_REMEDIATIONS);
    EXPECT_TRUE(valid);

    // Create a test Entry object with Windows remediations
    auto jbuf = parser.builder_.GetBufferPointer();
    flatbuffers::Verifier jverifier(jbuf, parser.builder_.GetSize());
    EXPECT_TRUE(cve_v5::VerifyEntryBuffer(jverifier));
    auto entry = cve_v5::GetEntry(jbuf);

    // Create a mock RocksDBWrapper object
    Utils::RocksDBWrapper rocksDBWrapper(REMEDIATIONS_DATABASE_PATH);

    // Assert result.
    ::testing::internal::CaptureStderr();
    EXPECT_NO_THROW(StoreRemediationsModel::updateRemediation(entry, rocksDBWrapper));
    std::string capturedSterr = ::testing::internal::GetCapturedStderr();
    EXPECT_STREQ("Field x_remediations not present.\n", capturedSterr.c_str());
}
