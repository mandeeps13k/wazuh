/*
 * Wazuh Vulnerability scanner
 * Copyright (C) 2015, Wazuh Inc.
 * March 25, 2023.
 *
 * This program is free software; you can redistribute it
 * and/or modify it under the terms of the GNU General Public
 * License (version 2) as published by the FSF - Free Software
 * Foundation.
 */

#include "vulnerabilityScanner.hpp"
#include "cjsonSmartDeleter.hpp"
#include "loggerHelper.h"
#include "vulnerabilityScannerFacade.hpp"
#include "vulnerability_scanner.h"
#include "wmodules_def.h"
#include <functional>
#include <string>

// TODO: Remove LCOV flags once the implementation of the 'Indexer Connector' module is completed
// LCOV_EXCL_START
void VulnerabilityScanner::start(const std::function<void(const modules_log_level_t, const std::string&)>& logFunction,
                                 const nlohmann::json& configuration)
{
    VulnerabilityScannerFacade::instance().start(logFunction, configuration);
}

void VulnerabilityScanner::stop()
{
    VulnerabilityScannerFacade::instance().stop();
}

#ifdef __cplusplus
extern "C"
{
#endif
    void vulnerability_scanner_start(full_log_t* logFuncs, const cJSON* configuration)
    {
        nlohmann::json configurationNlohmann;
        if (configuration)
        {
            const std::unique_ptr<char, CJsonSmartFree> spJsonBytes {cJSON_Print(configuration)};
            configurationNlohmann = nlohmann::json::parse(spJsonBytes.get());
        }

        Log::loggingObject.assignLogFunction(logFuncs->info, logFuncs->warn, logFuncs->debug1, logFuncs->debug2, logFuncs->error);
        logInfo(WM_VULNSCAN_LOGTAG, "VULDET TEST");

        auto logging {[](const modules_log_level_t logLevel, const std::string& logMessage)
                      {
                          switch (logLevel)
                          {
                              /*case LOG_ERROR: Log::error << logMessage << LogEndl; break;
                              case LOG_INFO: Log::info << logMessage << LogEndl; break;
                              case LOG_WARNING: Log::warning << logMessage << LogEndl; break;
                              case LOG_DEBUG: Log::debug << logMessage << LogEndl; break;
                              case LOG_DEBUG_VERBOSE: Log::debugVerbose << logMessage << LogEndl; break;*/
                          }
                      }};

        VulnerabilityScanner::instance().start(logging, configurationNlohmann);
    }

    void vulnerability_scanner_stop()
    {
        VulnerabilityScanner::instance().stop();
    }

    bool vulnerability_scanner_policy_change_event(const char* data)
    {
        return true;
    }
#ifdef __cplusplus
}
#endif
// LCOV_EXCL_STOP
